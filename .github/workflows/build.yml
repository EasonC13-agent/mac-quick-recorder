name: Build & Release DMG

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Build app
        run: |
          set -e
          APP="VoiceClip.app"
          mkdir -p "$APP/Contents/MacOS" "$APP/Contents/Resources"
          cp Info.plist "$APP/Contents/"
          cp AppIcon.icns "$APP/Contents/Resources/"
          
          swiftc VoiceClip.swift \
            -parse-as-library \
            -o "$APP/Contents/MacOS/VoiceClip-arm64" \
            -framework Cocoa \
            -framework AVFoundation \
            -framework Carbon \
            -target arm64-apple-macos13.0
          
          swiftc VoiceClip.swift \
            -parse-as-library \
            -o "$APP/Contents/MacOS/VoiceClip-x86" \
            -framework Cocoa \
            -framework AVFoundation \
            -framework Carbon \
            -target x86_64-apple-macos13.0
          
          lipo -create \
            "$APP/Contents/MacOS/VoiceClip-arm64" \
            "$APP/Contents/MacOS/VoiceClip-x86" \
            -output "$APP/Contents/MacOS/VoiceClip"
          
          rm "$APP/Contents/MacOS/VoiceClip-arm64" "$APP/Contents/MacOS/VoiceClip-x86"

      - name: Ad-hoc sign
        run: codesign --force --deep -s - VoiceClip.app

      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp -R VoiceClip.app dmg_contents/
          ln -s /Applications dmg_contents/Applications
          hdiutil create -volname "VoiceClip" -srcfolder dmg_contents \
            -ov -format UDZO VoiceClip.dmg

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: VoiceClip.dmg
          generate_release_notes: true
